version: '3.8'

# =============================================================================
# Content Intelligence - Docker Compose for Unraid
# =============================================================================
#
# SETUP:
# 1. Create a folder on Unraid: /mnt/user/appdata/content-intelligence/
# 2. Copy this file there as docker-compose.yml
# 3. Create a .env file in the same folder with your credentials (see below)
# 4. Run: docker compose up -d --build
#
# .env file content:
# DATABASE_URL=postgresql://postgres:YOUR_PASSWORD@10.50.50.10:6543/content_intelligence?schema=public
# DIRECT_URL=postgresql://postgres:YOUR_PASSWORD@10.50.50.10:6543/content_intelligence?schema=public
# NEXT_PUBLIC_APP_URL=http://YOUR_UNRAID_IP:3000
#
# =============================================================================

services:
  content-intelligence:
    build:
      context: https://github.com/Basically3011/content-intelligence.git#main
      dockerfile: Dockerfile
    container_name: content-intelligence
    image: content-intelligence:latest

    ports:
      - "3000:3000"

    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - DATABASE_URL=${DATABASE_URL}
      - DIRECT_URL=${DIRECT_URL}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Unraid labels
    labels:
      - "net.unraid.docker.managed=dockerman"
      - "net.unraid.docker.webui=http://[IP]:[PORT:3000]"

networks:
  default:
    driver: bridge
