version: '3.8'

# =============================================================================
# Content Intelligence - Docker Compose for Unraid
# =============================================================================
#
# SETUP FOR PRIVATE REPO:
# 1. Clone the repo on Unraid:
#    cd /mnt/user/appdata
#    git clone https://github.com/Basically3011/content-intelligence.git
#    (You'll be prompted for GitHub username and Personal Access Token)
#
# 2. Create a .env file in the cloned folder:
#    nano /mnt/user/appdata/content-intelligence/.env
#
# 3. Build and start:
#    cd /mnt/user/appdata/content-intelligence
#    docker compose -f docker-compose.unraid.yml up -d --build
#
# TO UPDATE:
#    cd /mnt/user/appdata/content-intelligence
#    git pull
#    docker compose -f docker-compose.unraid.yml up -d --build
#
# .env file content:
# DATABASE_URL=postgresql://postgres:YOUR_PASSWORD@pgvector:5432/content_intelligence?schema=public
# DIRECT_URL=postgresql://postgres:YOUR_PASSWORD@pgvector:5432/content_intelligence?schema=public
# NEXT_PUBLIC_APP_URL=http://YOUR_UNRAID_IP:3000
#
# NOTE: The database hostname should be the container name of your pgvector
#       database in the proxnet network (e.g., pgvector, postgres, etc.)
#
# =============================================================================

services:
  content-intelligence:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: content-intelligence
    image: content-intelligence:latest

    ports:
      - "3000:3000"

    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - DATABASE_URL=${DATABASE_URL}
      - DIRECT_URL=${DIRECT_URL}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Unraid labels
    labels:
      - "net.unraid.docker.managed=dockerman"
      - "net.unraid.docker.webui=http://[IP]:[PORT:3000]"

    # Connect to existing proxnet network where pgvector database runs
    networks:
      - proxnet

# Use existing external network (proxnet) where pgvector is running
networks:
  proxnet:
    external: true
